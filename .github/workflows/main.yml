name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Check out code
      uses: actions/checkout@v3

    - name: Build & start database
      run: |
        docker compose up -d database
        until docker compose exec database pg_isready -U test; do
          echo "Waiting for databaseâ€¦"
          sleep 2
        done

    - name: Run Go tests in container
      run: docker compose run --rm golang go test ./handlers -v

    - name: Tear down
      if: always()
      run: docker compose down -v
